# 更新日誌

所有重要的專案變更都會記錄在此檔案中。

---

## [未發布]

### 📊 程式碼健康度分析
- **完成專案健康度全面分析** (2025-10-13):
  - 總共分析 12 個 Python 檔案
  - 識別出高複雜度檔案 (music_window.py: 1979 行)
  - Git 變更頻率分析 (main.py 最高: 3 次變更)
  - 測試覆蓋率分析: 目前 0% → **39 個測試 (100% 通過!)**
  - 程式碼品質問題掃描:
    - ✅ 已修復硬編碼路徑問題
    - ✅ 已改善空例外處理區塊
    - 重複程式碼需重構 (待處理)
  - 提供詳細改善建議與優先順序
  - 總體健康度評分: 48/100 → **預估提升至 65/100**

### 新增 (2025-10-13) - 🌙 Overnight Development 設置
- **✨ Overnight Dev 功能**:
  - 建立 `.overnight-dev.json` 配置檔
  - 安裝 Git pre-commit hook (自動執行測試)
  - 安裝 Git commit-msg hook (強制 Conventional Commits 格式)
  - 測試框架完整整合
  - 每次 commit 自動執行 39 個測試
  - 支援 TDD 開發流程

### 新增 (2025-10-13) - 緊急程式碼品質改善
- **🧪 測試框架建立**:
  - 建立完整的 pytest 測試框架
  - 新增 `tests/` 目錄結構
  - 撰寫 39 個單元測試,覆蓋核心模組:
    - `test_config_manager.py` (15 個測試)
    - `test_music_manager.py` (12 個測試)
    - `test_rss_manager.py` (12 個測試)
  - 配置 `pytest.ini` 和 `conftest.py`
  - **測試覆蓋率**: 從 0% 提升到約 35%

- **📁 constants.py 常數模組**:
  - 建立統一的常數定義檔案
  - 定義路徑配置 (音樂目錄、下載目錄)
  - 定義 RSS 配置 (快取超時、最大文章數)
  - 定義 YouTube 配置 (搜尋/下載超時)
  - 定義 UI 主題顏色配置
  - 所有神奇數字都已移到常數檔案

### 修復 (2025-10-13) - 緊急程式碼品質改善
- **✅ 修復硬編碼路徑問題**:
  - `music_manager.py`: `'Z:/Shuvi'` → `DEFAULT_MUSIC_ROOT_PATH`
  - `youtube_downloader.py`: `"Z:/Shuvi/下載"` → `DEFAULT_DOWNLOAD_PATH`
  - 路徑現在使用用戶主目錄,跨平台相容
  - 預設路徑: `~/Music/AudioSwitcher` 和 `~/Downloads/AudioSwitcher`

- **✅ 改善例外處理與日誌記錄**:
  - `audio_manager.py`:
    - 移除空 `except` 區塊,改用 logger.error()
    - 新增 exc_info=True 記錄完整堆疊追蹤
  - `music_manager.py`:
    - JSON 解析失敗時記錄警告而非靜默跳過
    - 分類掃描失敗時記錄錯誤詳情
  - 所有例外現在都有適當的日誌記錄

- **⚙️ 神奇數字消除**:
  - RSS 快取超時: `300` → `RSS_CACHE_TIMEOUT`
  - RSS 最大文章數: `50` → `RSS_MAX_ENTRIES`
  - YouTube 搜尋超時: `45` → `YTDLP_SEARCH_TIMEOUT`
  - YouTube 下載超時: `600` → `YTDLP_DOWNLOAD_TIMEOUT`
  - 預設音量: `70` → `DEFAULT_MUSIC_VOLUME`

### 新增
- **樹狀資料夾結構 UI** (音樂播放器)
  - 左側使用 Treeview 顯示資料夾樹狀結構
  - 可展開/收合資料夾查看其中的歌曲
  - 雙擊資料夾展開/收合,雙擊歌曲播放
  - 右鍵選單功能:
    - 新增資料夾
    - 重新命名資料夾
    - 刪除資料夾(含確認對話框)
    - 播放歌曲
    - 刪除歌曲(含確認對話框)
    - **移動歌曲到不同分類** (2025-10-13)
  - 樹狀結構顯示歌曲時長和分類資訊

- **歌曲移動功能** (音樂播放器, 2025-10-13)
  - 右鍵點擊歌曲選擇「📁 移動到...」
  - 彈出對話框顯示當前位置與可選分類
  - 使用下拉式選單選擇目標分類
  - 自動檢查目標資料夾是否已有同名檔案
  - 同時移動音訊檔(.mp3)與元數據檔(.json)
  - 移動完成後自動重新載入音樂庫
  - 完整的錯誤處理與使用者提示

### 修復
- **修復空資料夾不顯示問題** (音樂播放器, 2025-10-13):
  - 新增資料夾後即使沒有歌曲也會在 UI 上顯示
  - 空資料夾會顯示「(空資料夾)」提示
  - 修正 `_load_music_library()` 函數邏輯

- **分類選擇對話框優化** (音樂下載)
  - 使用下拉式選單取代手動輸入分類名稱
  - 新增「+ 新增」按鈕快速創建新分類
  - 更直覺的使用者介面
  - 預設選擇第一個可用分類

- **YouTube 403 錯誤規避指南文檔** (YOUTUBE_403_FIX_GUIDE.md)
  - 完整的 6 個關鍵設定說明
  - 包含使用範例和常見問題解答
  - 效能影響分析表
  - 實作方法和設定說明

### 修復
- 修復音樂搜尋功能,現在可以搜尋藝術家名稱
- **全面優化 YouTube 下載 403 錯誤修正** (2025-10-13):
  - 🔑 **yt-dlp 版本更新**: 從 2024.08.06 更新至 2025.09.26 (最新版本)
  - 🔑 **mweb 客戶端優先**: 使用 `player_client=mweb,android` (2025 年 YouTube 最新建議)
  - 🔑 **跳過串流格式**: 使用 `skip=hls,dash` 避免額外請求
  - 🔑 **網路優化**: 加入 `source_address=0.0.0.0` 綁定預設網路介面
  - 🔑 **格式選擇優化**: 使用 `format=bestaudio/best` 靈活選擇
  - 🔑 **超時時間調整**: 搜尋/資訊獲取從 60 秒調整為 45 秒,下載從 5 分鐘延長到 10 分鐘
  - 🔑 **Cookie 支援增強**: 改進瀏覽器 cookies 測試邏輯
  - 🔑 **重試機制**: 新增 `--retries 3 --fragment-retries 3` 參數提升下載穩定性
  - 統一所有 yt-dlp 命令參數(搜尋、獲取資訊、下載)
  - 增強日誌訊息,清楚顯示使用的策略
  - ⚠️ **重要**: 由於 YouTube 持續更新防護機制,建議定期執行 `pip install --upgrade yt-dlp` 更新
- **修復搜尋下載流程** (2025-10-13):
  - 確認搜尋時只需在開始時選擇一次分類
  - 搜尋結果對話框會顯示預選的分類
  - 選擇影片後直接開始下載,不再重複詢問分類

### 改進
- 重構 PRD 文檔,簡化內容並只保留已做和待做部分
- 創建獨立的更新日誌文檔 (CHANGELOG.md)
- 改進音樂播放器 UI,使用樹狀結構替代原本的平面列表
- **YouTube 下載進度條** (2025-10-12):
  - 新增下載進度對話框,顯示下載狀態
  - 使用不確定模式的進度條動畫
  - 顯示下載階段提示(獲取資訊、下載等)
  - 下載完成或失敗後自動關閉進度框

### 移除
- **移除 Discord Rich Presence 功能**:
  - 刪除 `discord_presence.py` 模組
  - 從音樂播放器移除所有 Discord 整合程式碼
  - 刪除 `DISCORD_SETUP.md` 說明文檔
  - 簡化程式碼,減少依賴套件

### 改進
- **程式碼清理** (2025-10-12):
  - 移除未完成的 Coding Agent 功能
  - 刪除 `coding_agent.py` 和 `coding_agent_window.py` 模組
  - 從 `requirements.txt` 移除 `claude-agent-sdk` 和 `python-dotenv` 依賴
  - 更新 README.md 移除相關說明
  - 簡化專案結構，專注於核心功能

---

## [v2.5.0] - 2025-10-12

### 新增
- **音量設定持久化**: 音樂播放器音量設定會自動儲存並在重啟後恢復
- **Discord Rich Presence 整合**:
  - 在 Discord 上顯示正在播放的音樂資訊
  - 顯示歌曲標題、藝術家名稱
  - 顯示播放進度條和剩餘時間
  - 支援播放/暫停狀態更新
  - 需要安裝 pypresence: `pip install pypresence`

### 改進
- **日誌系統優化**: app.log 每次啟動時自動清空,只保留本次運行的紀錄
- **YouTube 下載功能改進**:
  - 修復 HTTP 403 錯誤問題
  - 自動嘗試從瀏覽器讀取 cookies (Chrome/Edge/Firefox)
  - 使用多個客戶端模式避開 bot 檢測
  - 提高下載成功率

---

## [v2.4.0] - 2025-10-12

### 新增
- **YouTube 搜尋功能**:
  - 在下載對話框輸入關鍵字搜尋 YouTube 影片
  - 返回最多 5 個搜尋結果供選擇
  - 顯示影片標題、上傳者、時長資訊
  - 選擇後自動開始下載流程

### 改進
- **專輯封面顯示優化**:
  - 保持原始圖片長寬比,不強制壓縮成正方形
  - 自動適應最大 250px 尺寸
  - 支援長方形和正方形封面

---

## [v2.3.0] - 2025-10-12

### 新增
- **YouTube 下載整合功能**:
  - 在播放器中直接下載 YouTube 音樂
  - 選擇下載到指定分類
  - 支援新增自訂分類
  - 背景執行緒下載避免阻塞介面
  - 自動生成 JSON 元數據
  - 下載完成後自動重新掃描音樂庫
  - 自動檢查 yt-dlp 是否已安裝

### 修復
- 修復托盤圖示未出現的問題

### 移除
- 移除快速切換裝置選單(保持雙裝置切換)

---

## [v2.2.0] - 2025-10-12

### 新增
- **專輯封面顯示功能**:
  - 自動從 thumbnail URL 載入專輯封面
  - 圖片快取機制避免重複下載
  - 預設封面圖示(無縮圖時)

- **播放模式增強功能**:
  - 🔁 單曲循環模式
  - 🔂 列表循環模式
  - 🔀 隨機播放模式
  - ➡️ 順序播放模式

- **音樂搜尋功能**:
  - 即時搜尋歌曲標題和分類
  - 一鍵清除搜尋
  - 支援與分類篩選結合使用

---

## [v2.1.0] - 2025-10-12

### 新增
- **音樂背景播放功能**: 關閉視窗後音樂繼續播放
- **系統托盤音樂控制選單**:
  - ⏯ 播放/暫停
  - ⏭ 下一首
  - ⏮ 上一首
  - ⏹ 停止
- 音樂控制操作顯示系統通知

### 修復
- 修復視窗重新開啟時的播放狀態同步問題

---

## [v2.0.0] - 2025-10-12

### 新增
- **RSS 訂閱管理功能**:
  - RSS 訂閱管理
  - RSS 已讀/未讀狀態管理
  - RSS 收藏功能
  - RSS 篩選和搜尋功能

- **本地音樂播放器**:
  - 本地音樂播放功能
  - 隨機播放模式
  - 播放進度追蹤
  - 藝術家資訊顯示

### 改進
- 改進所有視窗為深色主題
- 新增完整的日誌系統

### 移除
- 移除視窗底部的關閉按鈕

---

## [v1.0.0] - 2025-10-04

### 新增
- 初始版本發布
- 支援雙裝置快速切換
- 系統托盤整合
- 圖形化設定介面
- 開機自啟動功能
- 使用統計功能

---

## 格式說明

本更新日誌遵循 [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/) 格式規範。

版本號遵循 [語義化版本](https://semver.org/lang/zh-TW/) 規範:
- 主版本號:進行不相容的 API 變更時
- 次版本號:新增向下相容的功能時
- 修訂版本號:進行向下相容的問題修正時

### 變更類型
- **新增**: 新功能
- **改進**: 現有功能的改善
- **修復**: 錯誤修正
- **移除**: 移除的功能
- **安全性**: 安全性相關的修正
