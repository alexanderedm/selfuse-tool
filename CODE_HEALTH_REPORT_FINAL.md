# 專案健康度完整分析報告 (2025-10-13)

## 📊 專案總覽

- **專案路徑**: E:\VScode\selftool
- **Python 檔案總數**: 52 個 (23 原始碼 + 20 測試檔案 + 9 其他)
- **總測試數**: 339 個
- **測試通過率**: 99.4% (337/339)
- **整體測試覆蓋率**: 72%
- **平均複雜度**: A (3.94)
- **flake8 錯誤數**: 0

### 檔案規模分布

| 檔案名稱 | 行數 | 狀態 |
|---------|------|------|
| rss_window.py | 807 | 🔴 需要重構 |
| music_window.py | 774 | ✅ 已重構完成 |
| music_playlist_dialog.py | 648 | ⚠️ 需要關注 |
| settings_window.py | 525 | ⚠️ 需要關注 |
| music_download_dialog.py | 503 | ⚠️ 需要關注 |
| main.py | 472 | ⚠️ 需要關注 |

---

## 🔴 嚴重問題（需要立即處理）

### 1. **rss_window.py** - 技術債務熱點
- **行數**: 807 行
- **複雜度**:
  - `_filter_entries()`: **D (26)** 🔴 極高複雜度
  - `_on_entry_right_click()`: B (8)
  - `_update_entries_ui()`: B (7)
- **測試覆蓋率**: **7.7%** 🔴 極低
- **Git 變更**: 2 次提交
- **可維護性指數**: A (32.57) - 邊緣值

**問題分析**:
- ❌ 最大的技術債務：807 行巨大檔案
- ❌ 測試覆蓋率極低（7.7%）
- ❌ 有一個極高複雜度方法（CC=26）
- ✅ 變更頻率較低（2 次）

**建議**:
1. 🚨 **緊急**: 抽離 `_filter_entries()` 方法（CC=26 → 目標 <10）
2. 📦 **模組化**: 參考 music_window.py 的重構方式，抽離以下模組：
   - RSSFeedListView（訂閱列表）
   - RSSEntryListView（文章列表）
   - RSSPreviewView（預覽區域）
   - RSSFilterManager（篩選邏輯）
3. 🧪 **測試**: 新增至少 30 個單元測試（目標覆蓋率 60%+）
4. 🎯 **目標**: 將 rss_window.py 從 807 行減少到 < 400 行

---

### 2. **youtube_downloader.py** - 高複雜度 + 低測試覆蓋
- **行數**: 330 行
- **複雜度**:
  - `download_audio()`: **C (19)** 🔴 高複雜度
  - `search_youtube()`: B (9)
- **測試覆蓋率**: **10.6%** 🔴 極低
- **Git 變更**: 2 次提交

**問題分析**:
- ❌ 關鍵功能缺少測試（10.6%）
- ❌ `download_audio()` 複雜度過高（CC=19）
- ⚠️ 依賴外部工具（yt-dlp）

**建議**:
1. 🧪 **測試**: 新增 20+ 個單元測試（使用 Mock）
2. ♻️ **重構**: 拆分 `download_audio()` 為多個小方法
3. 🛡️ **錯誤處理**: 增強錯誤處理和日誌記錄

---

### 3. **settings_window.py** - 高複雜度 + 極低測試覆蓋
- **行數**: 525 行
- **複雜度**:
  - `show()`: **C (13)** 🔴 高複雜度
  - `_save_settings()`: **C (13)** 🔴 高複雜度
- **測試覆蓋率**: **4.0%** 🔴 極低
- **Git 變更**: 7 次提交

**問題分析**:
- ❌ 測試覆蓋率極低（4.0%）
- ❌ 兩個高複雜度方法（CC=13）
- ⚠️ 變更頻率較高（7 次），風險大

**建議**:
1. 🧪 **測試**: 新增至少 15 個單元測試
2. ♻️ **重構**: 拆分 `show()` 和 `_save_settings()` 方法
3. 📦 **模組化**: 抽離設定頁面的各個區塊

---

## ⚠️ 警告（需要關注）

### 1. **music_playback_view.py** - 低測試覆蓋
- **行數**: 427 行
- **測試覆蓋率**: **13.5%** ⚠️
- **複雜度**: 未檢測到高複雜度方法
- **Git 變更**: 新模組，最近新增

**建議**:
- 🧪 補充測試（已有 15 個，需要更多）
- 🎯 目標覆蓋率：50%+

### 2. **main.py** - 中等複雜度
- **行數**: 472 行
- **測試覆蓋率**: **45.7%** ⚠️
- **複雜度**: 多個 B (6) 等級方法
- **Git 變更**: 3 次提交

**建議**:
- 🧪 擴展測試覆蓋率到 60%+
- ♻️ 簡化複雜方法

### 3. **rss_manager.py** - 測試覆蓋不足
- **行數**: 390 行
- **測試覆蓋率**: **40.9%** ⚠️
- **Git 變更**: 2 次提交

**建議**:
- 🧪 新增 10+ 個測試，提升覆蓋率到 60%+

---

## ✅ 優秀實踐

### 1. **music_window.py** - 重構典範 ✨
- **行數**: 774 行（從 1,548 行減少 50%）
- **測試覆蓋率**: 28.1%（持續改善中）
- **複雜度**:
  - 最高方法: B (9) - 在可接受範圍內
  - 平均複雜度: A
- **Git 變更**: 17 次（最近大量重構）

**成就**:
- ✅ 成功從 1,548 行減少到 774 行（-50%）
- ✅ 抽離 11 個專門模組
- ✅ 無高複雜度方法（最高 CC=9）
- ✅ 模組化重構完成

### 2. **高測試覆蓋率模組** 🏆

| 模組 | 測試覆蓋率 | 測試數 |
|------|-----------|--------|
| config_manager.py | 55.1% | 17 |
| audio_manager.py | 100% | 11 |
| music_manager.py | 100% | 13 |
| play_history_manager.py | 100% | 15 |
| playlist_manager.py | 100% | 24 |
| path_utils.py | 100% | 7 |

### 3. **穩定模組** 📊
這些模組變更頻率低、複雜度低、測試覆蓋好：
- playlist_manager.py (100% 測試覆蓋)
- play_history_manager.py (100% 測試覆蓋)
- path_utils.py (100% 測試覆蓋)

---

## 📈 Git 變更熱點分析（最近 3 個月）

| 檔案 | 變更次數 | 風險評估 |
|------|---------|---------|
| music_window.py | 17 | ✅ 重構中（正常）|
| settings_window.py | 7 | ⚠️ 高變更 + 低測試 |
| music_manager.py | 4 | ✅ 穩定 |
| main.py | 3 | ⚠️ 中等變更 + 中等測試 |
| config_manager.py | 3 | ✅ 穩定 |

**分析**:
- **高風險**: settings_window.py（高變更 + 極低測試）
- **正常重構**: music_window.py（高變更 + 已完成重構）
- **穩定模組**: 大部分模組變更頻率低

---

## 🎯 優先級建議

### 🔥 高優先級（Week 1-2）

#### 1. **rss_window.py 重構**
- **目標**: 從 807 行減少到 < 400 行
- **步驟**:
  1. 抽離 RSSFeedListView 模組（~200 行）
  2. 抽離 RSSEntryListView 模組（~150 行）
  3. 抽離 RSSFilterManager 模組（~150 行）
  4. 重構 `_filter_entries()` 方法（CC 26 → <10）
- **測試**: 新增 30+ 個單元測試
- **預期成果**: 覆蓋率從 7.7% → 60%+

#### 2. **settings_window.py 測試補充**
- **目標**: 覆蓋率從 4% → 60%+
- **步驟**:
  1. 新增 15+ 個單元測試
  2. 重構 `show()` 和 `_save_settings()` 方法
- **預期成果**: 測試覆蓋率 60%+，複雜度降低

#### 3. **youtube_downloader.py 測試補充**
- **目標**: 覆蓋率從 10.6% → 60%+
- **步驟**:
  1. 新增 20+ 個單元測試（使用 Mock）
  2. 重構 `download_audio()` 方法（CC 19 → <10）
- **預期成果**: 測試覆蓋率 60%+

### ⚠️ 中優先級（Week 3-4）

#### 4. **main.py 測試擴展**
- 目標覆蓋率: 45.7% → 60%+
- 新增 10+ 個測試

#### 5. **rss_manager.py 測試補充**
- 目標覆蓋率: 40.9% → 60%+
- 新增 10+ 個測試

#### 6. **music_playback_view.py 測試補充**
- 目標覆蓋率: 13.5% → 50%+
- 新增測試

### 📝 低優先級（Week 5-8）

#### 7. **複雜度優化**
- 安裝並配置 radon 和 xenon
- 設定複雜度門檻（CC < 10）
- 重構所有 CC > 10 的方法

#### 8. **持續改善**
- 提升整體測試覆蓋率到 80%+
- 建立整合測試套件
- 更新開發者文檔

---

## 📊 專案健康度評分

| 指標 | 評分 | 狀態 |
|------|------|------|
| 測試覆蓋率 | 72% | 🟢 良好 |
| 測試通過率 | 99.4% | 🟢 優秀 |
| 平均複雜度 | A (3.94) | 🟢 優秀 |
| flake8 錯誤 | 0 | 🟢 完美 |
| 模組化程度 | 高 | 🟢 優秀 |
| 技術債務 | 中等 | ⚠️ 需改善 |

### 總體健康度: **🟢 85/100** (良好)

**優勢**:
- ✅ 測試覆蓋率良好（72%）
- ✅ 測試通過率優秀（99.4%）
- ✅ 代碼品質優秀（flake8 零錯誤）
- ✅ 平均複雜度低（A 級）
- ✅ music_window.py 重構完成

**需要改善**:
- ⚠️ rss_window.py 需要重構（807 行 + 7.7% 測試）
- ⚠️ settings_window.py 測試嚴重不足（4%）
- ⚠️ youtube_downloader.py 測試不足（10.6%）
- ⚠️ 部分模組存在高複雜度方法（CC > 10）

---

## 🎯 達成目標路徑

### 短期目標（1-2 週）
- [ ] rss_window.py 重構完成（< 400 行）
- [ ] settings_window.py 測試覆蓋率 > 60%
- [ ] youtube_downloader.py 測試覆蓋率 > 60%
- [ ] 整體測試覆蓋率提升到 75%+

### 中期目標（3-4 週）
- [ ] 所有主要模組測試覆蓋率 > 60%
- [ ] 所有方法複雜度 < 10
- [ ] 整體測試覆蓋率 80%+

### 長期目標（5-8 週）
- [ ] 整體健康度 > 90/100
- [ ] 測試覆蓋率 85%+
- [ ] 零技術債務

---

## 📝 結論

專案整體處於**良好狀態**，最近完成的 music_window.py 重構展示了優秀的軟體工程實踐。主要技術債務集中在 rss_window.py、settings_window.py 和 youtube_downloader.py 三個模組。

**建議優先處理**:
1. 🔥 rss_window.py 重構（最大技術債務）
2. 🧪 settings_window.py 測試補充（高風險）
3. 🧪 youtube_downloader.py 測試補充（關鍵功能）

通過上述改善，專案健康度可以從 85/100 提升到 90+/100，達到卓越水準。

---

**報告生成時間**: 2025-10-13
**分析工具**: pytest-cov, radon, git log, flake8
**分析範圍**: 52 個 Python 檔案，339 個測試
