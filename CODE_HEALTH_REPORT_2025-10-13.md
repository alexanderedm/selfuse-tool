# 程式碼健康度分析報告

**專案名稱**: 音訊輸出裝置快速切換工具 (AudioSwitcher)
**分析日期**: 2025-10-13
**分析者**: Claude Code (project-health-auditor)
**專案路徑**: E:\VScode\selftool

---

## 📊 執行摘要

### 總體健康度評分: 🟡 **68/100** (良好)

**整體評估**: 專案處於良好狀態,具備完整的測試框架和文檔系統,但仍存在一個關鍵的技術債務熱點需要立即處理。

| 評估維度 | 評分 | 狀態 |
|---------|------|------|
| **程式碼組織** | 75/100 | 🟡 良好 |
| **測試覆蓋率** | 70/100 | 🟡 良好 |
| **文檔完整性** | 95/100 | 🟢 優秀 |
| **程式碼品質** | 60/100 | 🟡 尚可 |
| **技術債務控制** | 45/100 | 🔴 需改善 |
| **開發活躍度** | 80/100 | 🟢 優秀 |

---

## 📁 專案概覽

### 程式碼規模統計

```
總檔案數:        40 個 Python 檔案
原始碼檔案:      23 個
測試檔案:        17 個
總程式碼行數:    13,102 行
平均檔案大小:    327 行

Git 活動度:
  - 過去 6 個月提交: 32 次
  - 活躍分支: main
  - 最近提交: 2025-10-13
```

### 測試覆蓋率概況

```
總測試數量:      267 個 (根據 CHANGELOG.md)
測試通過率:      100% ✅
估計覆蓋率:      ~55%
測試框架:        pytest + pytest-cov
```

### 核心模組分析

| 模組名稱 | 行數 | 複雜度 | 變更頻率 | 測試覆蓋率 | 健康度 |
|---------|------|--------|----------|-----------|--------|
| music_window.py | 1,549 | 🔴 極高 | 12 次 | ~20% | 🔴 25/100 |
| rss_window.py | 807 | 🟡 高 | 0 次 | 未知 | 🟡 50/100 |
| settings_window.py | 526 | 🟡 中 | 7 次 | 良好 | 🟢 65/100 |
| main.py | 473 | 🟢 中 | 3 次 | 良好 | 🟢 70/100 |
| rss_manager.py | 391 | 🟢 低 | 2 次 | 良好 | 🟢 80/100 |
| config_manager.py | 360 | 🟢 低 | 2 次 | 優秀 | 🟢 85/100 |
| youtube_downloader.py | 331 | 🟡 中 | 2 次 | 未知 | 🟡 55/100 |

---

## 🔥 技術債務熱點分析

### ⚠️ CRITICAL - 立即處理 (本週內)

#### 1. music_window.py - 高複雜度 + 高變更頻率 + 低測試覆蓋

**風險等級**: 🔴 **極高 (95/100)**

**問題描述**:
- **檔案大小**: 1,549 行 (建議 < 500 行)
- **變更頻率**: 12 次 (過去 6 個月最高)
- **測試覆蓋率**: ~20% (嚴重不足)
- **方法數量**: 50+ 個方法
- **職責過多**: 至少包含 8 個不同職責

**具體問題**:
```python
職責混亂:
  1. UI 渲染與佈局 (line 105-584)
  2. 音樂播放控制 (line 836-1020)
  3. 資料夾管理 (line 1256-1312)
  4. 播放列表管理 (line 1486-1532)
  5. YouTube 下載整合 (line 1196-1230)
  6. 歷史記錄管理 (line 1486-1493)
  7. 專輯封面處理 (line 1045-1149)
  8. 搜尋與篩選 (line 628-680)
```

**業務影響**:
- **Bug 風險**: 極高 (複雜度高 + 測試不足)
- **維護成本**: 極高 (理解困難,修改風險大)
- **開發速度**: 嚴重受阻 (任何修改都可能引入新 bug)

**建議行動** (預估工時: 3-5 天):

1. **階段 1: 抽離對話框模組** (已部分完成)
   ```
   ✅ MusicDownloadDialog (503 行) - 已完成
   ✅ MusicPlaylistDialog (648 行) - 已完成
   ✅ MusicHistoryDialog - 已完成
   ⏳ 剩餘工作: 確保所有對話框完全解耦
   ```

2. **階段 2: 抽離播放控制邏輯** (已部分完成)
   ```
   ✅ MusicPlaybackView (427 行) - 已完成
   ⏳ MusicPlayerController - 需進一步測試
   ```

3. **階段 3: UI 組件分離** (待完成)
   ```python
   建議新增模組:
   - MusicLibraryView (資料夾樹 + 歌曲列表)
   - MusicSearchView (搜尋框 + 篩選邏輯)
   - MusicHeaderView (頂部按鈕區域)
   ```

4. **階段 4: 增加測試覆蓋率** (關鍵!)
   ```
   目標: 20% → 60%
   新增測試數量: +60 tests
   重點測試:
   - 播放狀態管理
   - 播放列表操作
   - 搜尋與篩選
   - 錯誤處理路徑
   ```

**成功指標**:
- [ ] music_window.py < 800 行
- [ ] 測試覆蓋率 > 60%
- [ ] 無方法超過 50 行
- [ ] Cyclomatic Complexity < 10

---

### ⚠️ HIGH PRIORITY - 高優先級 (本月內)

#### 2. rss_window.py - 大型檔案 + 缺乏測試

**風險等級**: 🟡 **中高 (65/100)**

**問題描述**:
- **檔案大小**: 807 行
- **變更頻率**: 0 次 (穩定但未經測試驗證)
- **測試覆蓋率**: 未知 (可能為 0%)
- **複雜度**: 中高 (包含 RSS 訂閱、文章閱讀、收藏管理)

**建議行動** (預估工時: 2 天):
```python
1. 新增測試套件:
   - test_rss_window.py (+30 tests)
   - 測試 UI 元件建立
   - 測試文章列表渲染
   - 測試篩選與搜尋邏輯
   - 測試已讀/未讀狀態切換

2. 考慮模組化:
   - RSSFeedListView (訂閱列表)
   - RSSArticleView (文章閱讀)
   - RSSFilterView (篩選器)
```

#### 3. youtube_downloader.py - 複雜度高 + 錯誤處理關鍵

**風險等級**: 🟡 **中 (55/100)**

**問題描述**:
- **複雜邏輯**: 包含多種 YouTube 403 錯誤規避策略
- **外部依賴**: 依賴 yt-dlp 和多種瀏覽器 cookies
- **錯誤處理**: 關鍵業務邏輯,但測試不足

**建議行動** (預估工時: 1 天):
```python
1. 新增測試套件:
   - test_youtube_downloader.py (+20 tests)
   - Mock subprocess.run
   - 測試所有錯誤路徑
   - 測試超時處理
   - 測試瀏覽器 cookie 回退邏輯

2. 提取配置到 constants.py:
   - YTDLP_BASE_ARGS
   - YTDLP_COOKIE_BROWSERS
   - YTDLP_RETRY_CONFIG
```

---

## 📈 健康度趨勢分析

### 過去 3 個月改善情況

```
2025-07-13:  健康度 48/100
  - 無測試框架
  - 硬編碼路徑問題
  - 缺乏程式碼品質工具

2025-10-13:  健康度 65/100 (+17)
  - ✅ 建立完整測試框架 (267 tests)
  - ✅ 移除硬編碼,使用 constants.py
  - ✅ 整合 flake8 + Git hooks
  - ✅ TDD 實踐成功案例

2025-10-13:  健康度 68/100 (+3)
  - ✅ music_window.py 模組化重構
  - ✅ 新增 6 個專門模組
  - ✅ 測試覆蓋率提升至 ~55%
```

### 關鍵改善項目

**優點識別** ✅:
1. **完整的測試框架**: pytest + 267 個測試,100% 通過率
2. **優秀的文檔**: README, CHANGELOG, TODO, PRD 齊全且更新及時
3. **程式碼品質工具**: flake8 配置完善,Git hooks 自動檢查
4. **成功的重構案例**:
   - MusicFileManager (226 行,95% 覆蓋率)
   - PlaylistManager (30 tests,95% 覆蓋率)
   - PlayHistoryManager (16 tests,89% 覆蓋率)
5. **TDD 實踐**: 新模組先寫測試再實作
6. **Overnight Development**: 自動化測試流程

---

## 🎯 優先改善建議 (按業務影響排序)

### 🔥 緊急 (Week 1-2)

#### 任務 1: 完成 music_window.py 重構

**預估工時**: 3-5 天
**業務影響**: 極高 (消除主要技術債務)
**風險**: 中 (已有部分重構經驗)

**行動計畫**:
```markdown
Day 1-2: 抽離 UI 元件
  - [ ] 建立 MusicLibraryView (資料夾樹 + 歌曲列表)
  - [ ] 建立 MusicSearchView (搜尋與篩選)
  - [ ] 建立 MusicHeaderView (頂部按鈕區)
  - [ ] 更新 music_window.py 使用新元件

Day 3-4: 增加測試覆蓋率
  - [ ] 新增 test_music_library_view.py (+20 tests)
  - [ ] 新增 test_music_search_view.py (+15 tests)
  - [ ] 擴展 test_music_window.py (+25 tests)
  - [ ] 目標覆蓋率: 20% → 60%

Day 5: 驗證與重構
  - [ ] 執行所有測試 (目標: >320 tests 全過)
  - [ ] 檢查程式碼複雜度 (radon)
  - [ ] 更新文檔 (CHANGELOG, README)
  - [ ] 提交 Git commit
```

**成功指標**:
- music_window.py < 800 行
- 測試覆蓋率 > 60%
- 所有測試 100% 通過

---

### ⚠️ 高優先 (Week 3-4)

#### 任務 2: 提升其他模組測試覆蓋率

**預估工時**: 2-3 天
**業務影響**: 高 (提升整體穩定性)

**行動計畫**:
```markdown
Day 1: RSS 模組測試
  - [ ] test_rss_window.py (+30 tests)
  - [ ] test_rss_manager.py 補充 (+10 tests)

Day 2: YouTube 下載器測試
  - [ ] test_youtube_downloader.py (+20 tests)
  - [ ] Mock 所有外部依賴

Day 3: 其他模組補充
  - [ ] test_settings_window.py (+15 tests)
  - [ ] test_audio_manager.py 補充 (+10 tests)
```

**成功指標**:
- 整體測試覆蓋率 > 70%
- 總測試數 > 350

---

### 🎯 中期目標 (Week 5-8)

#### 任務 3: 程式碼品質全面提升

**預估工時**: 1-2 週
**業務影響**: 中 (長期維護性)

**行動計畫**:
```markdown
Week 1: 複雜度優化
  - [ ] 使用 radon 分析所有檔案
  - [ ] 重構 Cyclomatic Complexity > 10 的函數
  - [ ] 消除重複程式碼 (DRY 原則)
  - [ ] 統一錯誤處理模式

Week 2: 整合測試與文檔
  - [ ] 建立整合測試套件 (+20 tests)
  - [ ] 更新 API 文檔
  - [ ] 建立開發者指南
  - [ ] 更新架構圖
```

---

## 📊 3 個月改善目標

| 指標 | 目前 | 3 個月目標 | 改善幅度 |
|------|------|-----------|---------|
| **整體健康評分** | 68/100 | 85/100 | +25% |
| **測試覆蓋率** | ~55% | 75%+ | +36% |
| **最大檔案行數** | 1,549 | < 500 | -68% |
| **總測試數量** | 267 | 400+ | +50% |
| **技術債務檔案** | 1 個 | 0 個 | -100% |
| **平均複雜度** | 中 | 低 | -40% |

---

## 🛠️ 建議的開發流程改善

### 1. 引入複雜度分析工具

```bash
pip install radon
pip install xenon

# 分析程式碼複雜度
radon cc . -a -nb

# 設定複雜度門檻
xenon --max-absolute B --max-modules A --max-average A .
```

### 2. 擴展 Git Hooks

```bash
# .git/hooks/pre-commit (追加)
echo "執行複雜度檢查..."
radon cc -nc 10 -a .

echo "檢查測試覆蓋率..."
pytest --cov=. --cov-report=term --cov-fail-under=70
```

### 3. CI/CD 整合 (建議)

```yaml
# .github/workflows/ci.yml
name: CI
on: [push, pull_request]
jobs:
  test:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - name: 安裝依賴
        run: pip install -r requirements.txt
      - name: 執行測試
        run: pytest --cov=. --cov-report=xml
      - name: 上傳覆蓋率報告
        uses: codecov/codecov-action@v2
```

---

## 📝 結論與建議

### 專案優勢 ✅

1. **完整的測試框架**: 267 個測試,100% 通過率
2. **優秀的文檔**: 文檔完整且更新及時
3. **活躍的開發**: 過去 6 個月 32 次提交
4. **成功的重構案例**: 多個模組已達到優秀水準
5. **自動化測試流程**: Git hooks + Overnight Dev

### 關鍵風險 ⚠️

1. **music_window.py 是主要瓶頸**: 極高複雜度 + 低測試覆蓋
2. **部分模組測試不足**: rss_window, youtube_downloader
3. **缺乏整合測試**: 只有單元測試,缺乏端對端測試

### 最終建議

**立即行動** (本週):
1. 🔥 完成 music_window.py 重構 (最高優先級)
2. 📝 為新模組新增測試 (+60 tests)

**短期目標** (本月):
1. ⚠️ 補充其他模組測試 (+85 tests)
2. 🎯 整體測試覆蓋率達到 70%+

**中期目標** (3 個月):
1. 📊 整體健康度提升至 85/100
2. 🛠️ 引入 CI/CD 流程
3. 📚 完善開發者文檔

---

## 附錄

### A. 分析方法論

本報告使用以下維度進行分析:

1. **檔案大小與複雜度**: 使用行數、方法數量評估
2. **Git 變更頻率**: 分析過去 6 個月的提交歷史
3. **測試覆蓋率映射**: 結合測試數量與檔案大小估算
4. **技術債務識別**: 多維度交叉分析 (大小 + 變更 + 測試)

### B. 健康度評分標準

```
90-100: 優秀 - 維護優良,可作為典範
70-89:  良好 - 小幅改善即可
50-69:  尚可 - 需要計劃性重構
30-49:  較差 - 需要立即改善
0-29:   極差 - 嚴重技術債務
```

### C. 下次複查建議

**建議日期**: 2025-11-13 (1 個月後)
**複查重點**:
- music_window.py 重構是否完成
- 測試覆蓋率是否達到 70%+
- 技術債務熱點是否消除

---

**報告產生時間**: 2025-10-13 16:30
**分析工具版本**: Claude Code Agent v4.5
**報告版本**: v1.0
